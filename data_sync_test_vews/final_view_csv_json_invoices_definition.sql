-- View: FINAL_view_csv_json_invoices
-- Generated: 2025-07-12 11:39:29.743677

CREATE VIEW FINAL_view_csv_json_invoices AS
SELECT 
    COALESCE(flat.invoice_id, csv.invoice_id) AS invoice_id, COALESCE(flat.invoice_number, csv.invoice_number) AS invoice_number, COALESCE(flat.customer_id, csv.customer_id) AS customer_id, COALESCE(flat.customer_name, csv.customer_name) AS customer_name, COALESCE(flat.due_date, csv.due_date) AS due_date, COALESCE(flat.total, csv.total) AS total, COALESCE(flat.balance, csv.balance) AS balance, csv.created_timestamp, csv.updated_timestamp, csv.invoice_date, csv.invoice_status, csv.accounts_receivable, csv.company_id, csv.is_inclusive_tax, csv.purchase_order, csv.currency_code, csv.exchange_rate, csv.discount_type, csv.is_discount_before_tax, csv.template_name, csv.entity_discount_percent, csv.subtotal, csv.adjustment, csv.adjustment_description, csv.adjustment_account, csv.expected_payment_date, csv.last_payment_date, csv.payment_terms, csv.payment_terms_label, csv.early_payment_discount_percentage, csv.early_payment_discount_amount, csv.early_payment_discount_due_days, csv.notes, csv.terms_conditions, csv.entity_discount_amount, csv.branch_id, csv.branch_name, csv.shipping_charge, csv.shipping_charge_tax_id, csv.shipping_charge_tax_amount, csv.shipping_charge_tax_name, csv.shipping_charge_tax_percent, csv.shipping_charge_tax_type, csv.shipping_charge_account, csv.item_name, csv.item_desc, csv.quantity, csv.discount, csv.discount_amount, csv.item_total, csv.usage_unit, csv.item_price, csv.product_id, csv.brand, csv.sales_order_number, csv.subscription_id, csv.expense_reference_id, csv.recurrence_name, csv.paypal, csv.authorize_net, csv.google_checkout, csv.payflow_pro, csv.stripe, csv.paytm, csv.two_checkout, csv.braintree, csv.forte, csv.worldpay, csv.payments_pro, csv.square, csv.wepay, csv.razorpay, csv.icici_eazypay, csv.gocardless, csv.partial_payments, csv.billing_attention, csv.billing_address, csv.billing_street2, csv.billing_city, csv.billing_state, csv.billing_country, csv.billing_code, csv.billing_phone, csv.billing_fax, csv.shipping_attention, csv.shipping_address, csv.shipping_street2, csv.shipping_city, csv.shipping_state, csv.shipping_country, csv.shipping_code, csv.shipping_fax, csv.shipping_phone_number, csv.tds_name, csv.tds_percentage, csv.tds_amount, csv.tds_type, csv.sku, csv.project_id, csv.project_name, csv.round_off, csv.sales_person, csv.subject, csv.primary_contact_email_id, csv.primary_contact_mobile, csv.primary_contact_phone, csv.estimate_number, csv.region, csv.vehicle, csv.custom_charges, csv.shipping_bill_number, csv.shipping_bill_date, csv.shipping_bill_total, csv.port_code, csv.account, csv.account_code, csv.tax_id, csv.item_tax, csv.item_tax_percent, csv.item_tax_amount, csv.item_tax_type, csv.kit_combo_item_name, csv.item_cf_sku_category, csv.cf_reason_to_void, csv.data_source, flat.date, flat.status, flat.line_item_id, flat.item_id, flat.line_item_name, flat.line_item_quantity, flat.line_item_rate, flat.line_item_item_total, flat.line_item_account_name, flat.line_item_description, flat.line_item_unit, flat.line_item_tax_name, flat.line_item_tax_percentage,
    CASE 
        WHEN flat.invoice_number IS NOT NULL THEN 'json_precedence'
        ELSE 'csv_only' 
    END AS data_source,
    CASE 
        WHEN flat.invoice_number IS NOT NULL THEN 1  -- JSON priority
        ELSE 2  -- CSV backup
    END AS source_priority
FROM csv_invoices csv
LEFT JOIN view_flat_json_invoices flat ON csv.invoice_number = flat.invoice_number
WHERE COALESCE(flat.invoice_number, csv.invoice_number) IS NOT NULL;
